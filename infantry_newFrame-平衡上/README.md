# TDT-Frame

============

![](@ref T-DT.jpg)  
TDT-Frame  

---

下版规划：
1、互补滤波可选择来源
2、去掉FreeRTOS系统，用原schedule取代


注意问题
1、不允许直接使用空的句柄（传入空句柄是对任务本身进行操作，会出现意料之外的情况）

2、类的定义必须注意构造器问题，只允许构造一次（需要多个构造的话可以嵌套）

3、8Pin CAN线使用前必须进行检查，并且最近出现了一些CAN高can低互换的情况，CAN不同的时候注意检查，注意CAN总线终端电阻

4、新添加的sysTickUpTimeUs可以方便检查是否使用了空的句柄，注意检查

5、大家都没有使用输出设备（比如LCD），但是FreeRTOS的调试又机器依赖于其输出信息，所以各兵种大家可以自己开发DBUG方法

5、1、常用的DBUG方法：串口输出，OLED输出

5、2、常用的DBUG信息：任务历史高水位线（堆栈相关）、总栈剩余值，任务运行状态、当前所有任务状态

5、3、具体所用到DBUG函数可以参考开发手册

6、systickuptime这个变量被置零大概率只有两种情况：复位，操作系统断言。如果确定没有复位，检查一下操作系统堆栈分配

7、stm32软件复位方法：https://www.cnblogs.com/achao123456/p/6549106.html、stm32复位检测方法：https://blog.csdn.net/u010361744/article/details/97158204

版本说明
最新版本: 2.3.0
更新说明: 
1、修复Mpu6050无法正常初始化
2、ImuCalc中nowAngle, lastAngle范围为0-360°, Angle为总角度
3、Mpu6050中IIC初始化放在Mpu6050_Init中
4、Mpu6050等需要高精准延时且无中断的任务的初始化应放在main函数，优先级分组和滴答定时器配置完之后
5、中断优先级分组、滴答定时器配置放在main函数开头
6、修复虚任务类设置任务句柄不会真实设置的bug

历史提交: #2.2.10 优化虚任务类遥控器更新逻辑
1、只有遥控器在线才会更新
2、dbus脱力标志位变量名优化

历史提交: #2.2.9 添加无线调试任务
1、修复电流输出限幅逻辑
2、flash存储适配任务级

历史提交: #2.2.8 修复开启陀螺仪会使看门狗复位

历史提交: #2.2.7 修复初始化、DEBUG任务BUG，完善代码规范
1、完善部分代码规范
2、将部分模块的初始化移到任务内
3、删除cycle函数，全部由Cycle类替代
4、优化LED闪烁，LED最低闪烁ID调至2，添加LED开关方法
5、将部分延时函数改为了任务级延时
6、修复Debug任务的部分BUG
7、修复OLED支持单双屏
8、默认开启看门狗，喂狗函数放在了LED
9、减少默认开启的任务，只保留LED任务
10、增加IMU任务的堆栈
11、修复OLED清屏失败BUG

历史提交: #2.2.6 修复虚任务类无法调用相关方法的bug

历史提交: #2.2.5 添加虚任务类，负责接收遥控器之后的处理
1、添加虚任务类，在遥控器脱力与取消脱力时会调用回调函数，以及遥控器数据接收后会调用遥控器更新函数，这些函数都可重写
2、修复motor类位置控制bug
3、pid间隔时间长时会只进行error计算，并只计算偏差并返回偏差

历史提交: #2.2.4 (beta)完善SPI，待测试
1、添加SPI3初始化
2、完善参数传递逻辑
3、完善CS片选逻辑
4、解决while死循环卡死问题（初始化仍待解决）
5、代码待测试，SPI部分请等下一版本

历史提交: #2.2.4RC fbValuePtr内置于pid类中
1、pid类中，通过set(get)PlanNum来设置（获取）方案数
2、优化canInfo的赋值逻辑
3、将motor类的pid指针对象改为实例对象，并设定pid的方案数为1，反馈值指针为can接收的speed和totleEncoder
4、pid类在计算时会先对参数进行检查

历史提交: #2.2.3.1128_RC 优化部分逻辑
1、my_math添加rpm、dps、radps转换的函数
2、pid类、motor类公有成员置于私有变量前
3、pid参数结构体将决定采用哪种pid微积分算法
4、简化pid类、motor类
5、添加部分注释
6、motor类：脱力时电流值将发送0；电机丢失时双环设定值清零
7、优化DJI电机检查代码
6、优化发送定时器回调函数
7、去除gimbal_task（测试代码）

历史提交：2.2.2 为了应对不同方案号也需要不同的反馈值来源，添加PidParamFbPtr

历史提交: 2.2.0 修复pid反馈值指针类型错误而导致的正反馈

历史提交: 2.1.1 修复Cycle类错误
1、pid融入cycle

2、修改部分注释

历史提交: 2.1.0 添加_FbValuePtr万能指针
1、通过重载操作运算符，可以想普通指针那样设置地址以及获取对应的值
使用范例
```
fbValuePtr = &a;//设置指针
a = *fbValuePtr;//获取值
```
历史提交: 2.0.14 添加读取电机类型对应的输出参数
1、分两个版本，一个是对象可调用的，直接返回当前电机对象对应类型的相关参数。另一个是静态类函数，通过传入电机类型，获取对应参数。

历史提交: 2.0.13 变量名优化
适配vscode的code spell checker插件，使其不报warning

历史版本: 2.0.12 合并IIC和SPI提交

历史版本: 2.0.11 SPI陀螺仪
1、添加SPI类

2、添加ICM20602陀螺仪设备

3、添加ICM42605陀螺仪设备（没测试）

4、未适配IMU

历史版本: 2.0.10 硬件iic

历史版本: 2.0.9 2.0.8补丁
1、解决升级ac6后debug任务堆栈不够的问题

2、更新错误计算时钟地址漏洞

3、修复因编译器优化导致systick中断无法进入

历史版本: 2.0.8升级ac6编译器

历史版本: 2.0.7软件iic频率可调

历史版本: 2.0.6电机机械角补偿优化

1、零点校正算法进行优化

2、修复can自动发送的软件定时器无法启动的bug

历史版本: 2.0.5将vision分支并入主分支FrameV2.0
1、小改协议

历史版本: 2.0.4软件IIC
1、mpu6050继承softiic和imu类

2、软件iic增加通用收发函数

3、原读取写入函数整合到寄存器写入读取函数中

4、使用硬件iic地址无需移位

历史版本: 2.0.3更改can信息发送的方式
1、将can发送改为软件定时器

历史版本: 2.0.2变量名规范更改
1、主要针对MotoList等命名

历史版本: 2.0.1pid移植中
1、将高阶的pid所用到的参数完全添加到结构体中

历史版本: 2.0.0电机类更新
1、删去Feedback类，CanInfo单独整合

2、方案号最大值不限制，通过传参设定方案号最大值以及内外环Pid对象指针

3、可通过对motor对象使用Motor_FbValue_Init进行反馈值设定

4、关联电机方法修改

历史版本: 1.6.3(fix) 修改陀螺仪阈值
1、尽量每个兵种都根据自己的陀螺仪调整一下阈值

历史版本: 1.6.3
1、增加主控版本（在C/C++选项卡更改）

2、添加遥控器重启代码，左摇杆左下，右摇杆右下，持续2s

3、减小了陀螺仪校准方差的阈值

历史版本：1.6.2
1、修改oled.cpp 编码为utf-8 bom

历史版本：1.6.1
1、Oled字库编码改为utf-8 bom

2、任务和系统级延时函数修改

历史版本：1.6.0
1、feedback类放弃new配合delete方案，使用局部变量申请内存

2、遥控器完善鼠标左右按键的跳变和按下处理

3、Feedback类clear函数保留CanInfo结构体中offsetEcoder变量

4、修复最大方案数需要比实际方案数大1的BUG

5、补充readme说明：uart部分代码未做任何测试，还请重新设计

6、补充完善陀螺仪代码，添加自动校准使能宏定义

7、添加oled驱动文件和dbug_task，用于向SPI口接出的oled屏幕打印dbug信息

8、添加了oled初始化程序，但是处于注释状态，有需要可启用，目前只需初始化即可，其他基本无需配置

历史版本：1.5.3
1、修复云台电机（GM6020、GM3510）电机初始化圈数可能不为零的问题

历史版本：1.5.2
1、更新了DBUS新方式解析键盘按键的代码

2、修复了按键值结果未右移的BUG

3、补充了鼠标XY轴，左右按键变量的代码

历史版本：1.5.1
1、修复参数传递时传递了指针，导致同标识符电机组参数传递后闭环数据串扰的BUG

历史版本：1.5.0
1、修复BUG

2、此版本用于测试

历史版本：1.4.1
1、删除了Motor类关于电机方向相关的定义，因其在使用过程中与位较零有冲突以及实际使用时出现的疯转现象

历史版本：1.4.0
1、解决1.3.6中遗漏Bug

历史版本：1.3.6
1、通过获取定义的枚举行数来获取枚举的个数

2、可通过motor类里面的PlanNum进行参数检查

3、Can_Info里添加了与陀螺仪单位相同角度（度）与角速度（度每秒
）【浮点】，方便云台使用（默认方案还是 度（整型）与转速（转每分））

历史版本：1.3.5
1、测试原方案

2、所有方案允许直接使用CAN反馈

历史版本：1.3.4
1、更新元素枚举和Motor类总方案数

1、添加陀螺仪动态校准功能

2、解决电机初始化时先使用后赋值的bug

3、跟进了在main.cpp的版本号

历史版本：1.3.2
1、补全pid.cpp中遗漏的参数

历史版本：1.3.1
1、允许PID设置参数时确定电机是负反馈(negetive)还是正反馈(positive)

2、clear中添加get_pid_T

3、删除默认初始化方法,强制构造

4、添加三个宏定义，mTaskNotifyGive(handle)，mTaskSuspend(handle)，mTaskResume(handle)，接受传入空句柄（不执行）

历史版本：1.3.0
1、pid参数添加结构体用于从结构体传入参数

2、部分敏感枚举名放在了结构体里，或者使用了命名空间进行限制，使用的是时候务必确认命名空间

3、电机过热检测使用可选式，避免无反馈电机的异常

4、使用new方法创建Feedback，PID对象，减少了内存开销

5、使用句柄的时候自动检测，如果监测到使用了空的句柄，sysTickUpTimeUS置零。

6、can口和ID确认的电机已存在时不初始化变量

7、间隔时间超过100ms自动清时间和i积分

8、Feedback类添加Get_Position和Get_Speed方法

9、解决get_cycle_T时间四倍Bug

10、允许电机构造时自定义是否使能

11、添加未使能电机的使能函数

12、添加sysTickUpTimeUS：us计数，使用空句柄和复位时清零

历史版本：1.2.2
1、测试用更新，可以忽略

历史版本：1.2.1
1、更改new标志位数据类型

2、添加空的电机重载方法

3、允许定义的电机不使能

4、改写合帧发送函数

5、改写PID计算函数

6、添加电机状态设置函数

7、更改PID中微分项除以两次时间常数的问题

8、添加微分低通滤波系数设置

9、添加解决微分输出高频干扰的一阶低通滤波函数

10、正反馈检测（日后填坑）

历史版本：1.2.0
1、解决电机转到700多圈就溢出BUG

2、添加Delete的运行条件

历史版本：1.1.6
1、解决IMU过圈BUG

2、Roll轴IMU过圈有问题，取消roll和pitch的过圈

3、解决canSendFlag标志位为0问题

历史版本：1.1.5
1、添加对非大疆电机的处理方法

2、根据代码规范，更改了部分函数名

3、添加了输出函数的函数指针

历史版本：1.1.4
1、中文编码由GB2312更改为UTF-8，以支持Git

历史版本：1.1.3
1、更新更改反馈地址的方法

历史版本：1.1.2
1、确认了参数号传递问题

2、改写Imu.cpp中ImuUpData为类

3、添加陀螺仪三轴过圈处理

历史版本：1.1.1
1、删除USB相关文件

2、补全电机正反向的控制代码

3、更新error_task示例任务

4、允许feedback更改反馈来源的宏支持可选参数

5、pid和反馈来源使用同一个参数号

6、完善部分注释

7、去除电机信息中反馈来源部分变量，参数号直接由入参得到

历史版本：1.1
1、追加DSP_Lib中的文件

2、更新追踪文件

历史版本：1.0
1、首次提交

框架说明
1、框架使用C++和C的混编以及FreeRTOS操作系统，主要是看中了C++的类和RTOS的任务调度。

2、参考TDT-Temple工程文件（飞镖的主控程序）。

3、框架中文件较少，但是保证框架中模块的更新，包括但不限于曲线拟合，姿态解算等算法。

4、各兵种可以自由使用框架和修改，但要保留更新的接口（尽量使用添加操作，减少删除和修改）。

5、对于各种各样，大大小小的BUG，烦请大家积极反馈。

6、框架的更新以大版本为主（会注明），小版本为辐，master为主，其他分支为辐。

7、为了适应不同的兵种，对于特定模块可能会添加少量的分支，但不保证和master分支的一致性和及时性。

8、版本更新会注明版本号，如1.2.3.191201，前三位为主要版本号，后面是时间，数字“1”位最重要，当有重大更新时变更，之后重要级别依次下降。

9、原则上当第二级别版本号变更或者解决重大BUG时时，会希望大家检查一次是否有更新的必要（我会在群里通知一下下）。

10、各兵种有任何意见也希望积极反馈，对于大家都需要的模块会尽量添加到框架中。

其他可选但未加入的功能
OLED 通过六线SPI口（一块屏幕）或者七线SPI口（可以接两块屏幕），控制OLED屏幕的驱动，适合F4

DBUG 集成了我常用的DBUG功能，配合OLED有奇效，可选串口1或者OLED

C++注意事项：
所有中断必须在头文件声明，

头文件需要注明混编，详情请询问

FreeRTOS注意事项
暂时FreeRTOS容错率非常低，必须确认所有任务调度环节正常才可能正常运行，当出现以下情况时可能凉凉

看门狗无法喂狗
大部分是喂狗任务被“饿死”，也就是任务调度一直轮不上喂狗函数，检查其他高优先级函数是否有延时，或者延时是否确定执行

直接跑死
检查是不是调用了未创建的任务的任务句柄

编译出现意料外错误
魔术棒-Device-右边有个software pack，和同伴对比一下

...
注意：为了加快编译速度，减少编译量，ST_Lib文件夹中部分文件做了不编译处理，
如果需要用到相关功能文件的话，记得取消不编译！！！！！

约定：
返回值0为假，非零为真

非类内定义的带static的函数意味着为辅助函数，只能在本文件调用

函数于函数之间间隔不少于三行

一个函数行数尽量别太多，多就分开

务必记得规范缩进

变量命名大小写规范：
变量名 小驼峰：robotLab;

常量名 全大写中间_划开：ROBOT_LAB;

类，枚举，结构，对象 ： 大驼峰：RobotLab；

缩写都大写 RL；

数组 robotLab[10];可以灵活

函数 大驼峰,中间划开：void Robot_Lab(void);

其他建议
缩进的空格数为4个

“{” 和 “}”各自独占一行。其中if应该换行，让“{”独占一行。

当if的判断和执行句子较短时，也需要换行。

较长的语句需要换行，换行后也要注意缩进对齐，使得排版整洁

switch-case语句标准格式

if、for、do、while、case、switch、default语句独占一行，

if、for、do、while语句的执行语句部分无论多少都要加大括号"{}"。

不允许把多个短语句写在一行中，即一行只写一条语句。

对齐只使用空格键，不使用TAB键。

文件头部应进行注释，注释必须列出：版权说明、版本号、生成日期、作者、内容、功能、修改日志等。

函数头部应进行注释，列出：函数的目的/功能、输入参数、输出参数、返回值、调用关系（函数、表）等。

在程序块的结束行右方加注释标记，以表明某程序块的结束。

注释格式尽量统一，建议使用“/* …… */”。

避免使用不易理解的数字，用有意义的标识来替代。

防止局部变量与公共变量同名。

严禁使用未经初始化的变量作为右值。

编程时，要注意数据类型的强制转换。

检查函数所有参数输入的有效性。